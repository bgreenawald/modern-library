---
import { getCollection } from 'astro:content';
import { fetchTags, type GithubTag } from '../../lib/github';

export async function getStaticPaths() {
  const books = await getCollection('books');
  const tags = await fetchTags();

  return books.map(book => {
    const versions = tags.filter(tag => tag.name.startsWith(book.slug));
    return {
      params: { book: book.slug },
      props: { book, versions },
    };
  });
}

const { book, versions } = Astro.props;
---

<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width" />
  <title>{book.data.title}</title>
</head>
<body>
  <h1>{book.data.title}</h1>
  <p>by {book.data.author}</p>
  <p>Published in {book.data.original_publication_year}</p>
  <p>{book.data.description}</p>
  <p>Genres: {book.data.genres.join(', ')}</p>
  {book.data.tags && <p>Tags: {book.data.tags.join(', ')}</p>}

  <h2>Versions</h2>
  <ul>
    {versions.map((version: GithubTag) => (
      <li>
        <a href={`/books/${book.slug}/${version.name}`}>{version.name}</a>
      </li>
    ))}
  </ul>
</body>
</html>